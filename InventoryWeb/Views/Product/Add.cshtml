@{
    ViewData["Title"] = "Add Product";
}

@model ProductVM

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">

            <div class="card bg-body shadow-sm">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="mb-0">Add Product</h3>
                </div>

                <div class="card-body">

                    <form method="post" enctype="multipart/form-data">

                        <!-- Product Name -->
                        <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control" asp-for="Product.Name">
                            <span class="text-danger" asp-validation-for="Product.Name"></span>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label class="form-label" asp-for="Product.CategoryId">Category</label>
                            <select class="form-select" asp-for="Product.CategoryId" asp-items="@Model.CategoryList" required>
                                <option disabled selected value="">--Select Category--</option>
                            </select>
                            <span class="text-danger" asp-validation-for="Product.CategoryId"></span>
                        </div>

                        <!-- Price -->
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="text" class="form-control" asp-for="Product.Price" pattern="^\d+(\.\d{2})?$">
                            <span class="text-danger" asp-validation-for="Product.Price"></span>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="3" asp-for="Product.Description"></textarea>
                            <span class="text-danger" asp-validation-for="Product.Description"></span>
                        </div>

                        <!-- Image -->
                        @* <div class="mb-3">
                            <label class="form-label">Select Image</label>
                            <input type="file" class="form-control" name="file">
                        </div> *@

                        @* <div class="mb-3">
                            <label class="form-label">Select Image</label>

                            <input type="file"
                                   class="form-control"
                                   name="file"
                                   id="fileInput"
                                   accept=".jpg, .jpeg, .png, .webp">

                            <span asp-validation-for="file" class="text-danger"></span>
                            <span id="fileError" class="text-danger">@Html.ValidationMessage("file")</span>
                        </div> *@

                        <div class="mb-3">
                            <label class="form-label">Select Image
                                <button type="button"
                                        class="btn btn-sm btn-info"
                                        data-bs-toggle="modal"
                                        data-bs-target="#imageInfoModal"
                                        title="Image requirements">
                                    <i class="bi bi-info-circle"></i>
                                </button>

                            </label>

                            <div class="input-group">
                                <input type="file"
                                       class="form-control"
                                       name="File"
                                       id="fileInput"
                                       accept=".jpg, .jpeg, .png, .webp">

                                <button class="btn btn-outline-secondary" type="button" id="removeFileBtn">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>


                            @* @if (TempData["SelectedFileName"] != null)
                            {
                                <div id="selectedFileName" class="mt-1 text-secondary small">Selected File: @TempData["SelectedFileName"]</div>
                            } *@

                            <div id="imageInfo"
                                 class="mt-1 small text-muted"
                                 style="display:none;">
                            </div>

                            <span asp-validation-for="File" class="text-danger" id="fileError"></span>
                        </div>



                        <!-- Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a asp-controller="Product" asp-action="Index" class="btn btn-secondary px-4">
                                Back
                            </a>

                            <button type="submit" class="btn btn-success px-4">
                                Add
                            </button>
                        </div>

                    </form>

                </div>

            </div>

        </div>
    </div>
</div>



@* ----------------------------BOOTSTRAP MODAL--------------------------------- *@
<div class="modal fade" id="imageInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-dark">
                <h5 class="modal-title">Image Requirements</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>Allowed formats:</strong> JPG, JPEG, PNG, WEBP
                    </li>
                    <li class="list-group-item">
                        <strong>Max file size:</strong> 500 KB
                    </li>
                    <li class="list-group-item">
                        <strong>Minimum dimensions:</strong> 400 × 400 px
                    </li>
                    <li class="list-group-item">
                        <strong>Maximum dimensions:</strong> 2000 × 2000 px
                    </li>
                </ul>
            </div>

           
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}


<script>

    const fileInput = document.getElementById("fileInput");
    const removeBtn = document.getElementById("removeFileBtn");
    const fileError = document.getElementById("fileError");
    // const selectedFileNameDiv = document.getElementById("selectedFileName");

    const imageInfo = document.getElementById("imageInfo");

    // Validation settings
    const MAX_SIZE_KB = 200;
    const MIN_WIDTH = 400, MIN_HEIGHT = 400;
    const MAX_WIDTH = 2000, MAX_HEIGHT = 2000;
    const ALLOWED_EXTENSIONS = [".jpg", ".jpeg", ".png", ".webp"];

    // Handle file selection
    fileInput.addEventListener("change", function () {
        const file = fileInput.files[0];

        fileError.textContent = "";
        imageInfo.style.display = "none";

        if (!file) return;


        // Show filename
        // if (selectedFileNameDiv) {
        //     selectedFileNameDiv.textContent = "Selected File: " + file.name;
        //     selectedFileNameDiv.classList.remove("text-secondary");
        //     selectedFileNameDiv.classList.add("text-dark");
        //     selectedFileNameDiv.style.display = "block";
        // }

        // 1️⃣ Extension check
        const ext = file.name.substring(file.name.lastIndexOf(".")).toLowerCase();
        if (!ALLOWED_EXTENSIONS.includes(ext)) {
            fileError.textContent = "Only JPG, PNG, or WEBP images are allowed.";
            return;
        }

        

        const sizeKB = (file.size / 1024).toFixed(1);
        // 3️⃣ Dimensions & corruption check
        const img = new Image();
        img.onload = function () {

            imageInfo.textContent =
            `Size: ${sizeKB} KB | Dimensions: ${img.width} × ${img.height} px`;
        imageInfo.style.display = "block";

            // 2️⃣ Size check
        if (file.size > MAX_SIZE_KB * 1024) {
            fileError.textContent = `File too large (max ${MAX_SIZE_KB} KB).`;
            // return;
        }


            if (
                img.width < MIN_WIDTH || img.height < MIN_HEIGHT ||
                img.width > MAX_WIDTH || img.height > MAX_HEIGHT
            ) {
                fileError.textContent =
                    `Image dimensions must be between ${MIN_WIDTH}×${MIN_HEIGHT} and ${MAX_WIDTH}×${MAX_HEIGHT} pixels.`;
            }
        };
        img.onerror = function () {
            imageInfo.style.display = "none";
            fileError.textContent = "Invalid or corrupted image file.";
        };
        img.src = URL.createObjectURL(file);
    });

    // Handle remove button
    removeBtn.addEventListener("click", function () {
        fileInput.value = "";
        fileError.textContent = "";
        imageInfo.style.display = "none";

        if (selectedFileNameDiv) {
            selectedFileNameDiv.style.display = "none";
        }
    });

    // Prevent form submission if file has error
    const form = fileInput.closest("form");
    form.addEventListener("submit", function (e) {
        if (fileError.textContent.trim() !== "") {
            e.preventDefault();
            // fileInput.classList.add("is-invalid"); Bootstrap highlight
            fileInput.focus();
        } else {
            fileInput.classList.remove("is-invalid");
        }
    });

</script>

