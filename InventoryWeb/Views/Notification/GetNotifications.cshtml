@model List<UnreadNotification>

@{
    ViewData["Title"] = "Notifications";
    var indiaTimeZone = TimeZoneInfo.FindSystemTimeZoneById("India Standard Time");
}

<div class="container mt-4">
    <h2 class=" mb-3">Unread Notifications</h2>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">No unread notifications.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered align-middle" >
                <thead class="table-dark">
                    <tr>
                        <th>Message</th>
                        <th>Current Stock</th>
                        <th class="text-end">Date & Time</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var indiaTime = TimeZoneInfo.ConvertTimeFromUtc(
                        item.TimeCreated,
                        indiaTimeZone
                        ).ToString("dd-MMM-yyyy hh:mm tt");

                        <tr id="notification-@item.NotificationId">
                            <td>@item.ProductName is less (75) in stock</td>
                            <td>@item.CurrentStock</td>
                            <td class="text-end">@indiaTime</td>
                            <td class="text-center">
                                <button class="btn btn-danger btn-sm" onclick="dismissNotification(@item.NotificationId)">
                                    <i class="bi bi-trash3 me-1"></i> Dismiss
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>


<script>
    async function dismissNotification(notificationId) {
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const response = await fetch(`/notification/dismissnotification?id=${notificationId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token
                }
            });

            if (response.ok) 
            {
                // Disable the row after successful dismissal
                const row = document.getElementById(`notification-${notificationId}`);
                if (row) {
                    row.style.opacity = '0.5'; // visually disable
                    row.querySelectorAll('button').forEach(b => b.disabled = true);
                }
            } else {
                console.error('Failed to dismiss notification');
            }
        } catch (err) {
            console.error(err);
        }
    }
</script>
